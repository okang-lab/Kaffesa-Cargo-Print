# index.py
# Nihai Stabil Versiyon: TÃ¼m Ã¶zellikler entegre, sekmeli veri okuma, boÅŸ satÄ±r sorununu Ã§Ã¶zer
# requirements: streamlit, reportlab, pandas

import io, os, re, base64, textwrap, unicodedata
import pandas as pd
import streamlit as st
import streamlit.components.v1 as components
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.lib.units import mm
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.utils import ImageReader

# -------------------------
# Ayarlar ve Sabitler
# -------------------------
st.set_page_config(page_title="Kargo Etiket OluÅŸturucu", layout="wide")

# SÃœTUN NUMARALARI (Excel A=0, B=1... diye sayÄ±lÄ±r)
COL_NAME = 8      # I sÃ¼tunu
COL_ADDRESS = 16  # Q sÃ¼tunu
COL_PHONE = 17    # R sÃ¼tunu
COL_PAYMENT = 18  # S sÃ¼tunu
MIN_COLUMN_COUNT = 19 # Bir satÄ±rÄ±n geÃ§erli olmasÄ± iÃ§in en az S sÃ¼tununa kadar veri olmalÄ±

# -------------------------
# GÃ¶nderici Bilgileri
# -------------------------
ISTANBUL_INFO = """KAFFESA GIDA SANAYÄ° VE DIÅ TÄ°CARET ANONÄ°M ÅÄ°RKETÄ°
Adres: BALMUMCU MAH. BARBAROS BULVARI Ä°BA BLOKLARI, 34/A
Ä°l/Ä°lÃ§e: BeÅŸiktaÅŸ/Ä°stanbul
Tel: 0212 265 16 16"""

ANKARA_INFO = """KAFFESA GIDA SANAYÄ° VE DIÅ TÄ°CARET ANONÄ°M ÅÄ°RKETÄ°
Adres: TURAN GÃœNEÅ BULVARI 55/3
Ä°l/Ä°lÃ§e: Ã‡ankaya / Ankara
Tel: 0312 476 16 16 / +90 537 472 59 48"""

SENDER_BLOCK_DEFAULT = ISTANBUL_INFO  # VarsayÄ±lan Ä°stanbul

# --- Font ve Logo YÃ¼kleme ---
FONT_PATH = "DejaVuSans.ttf"
if os.path.isfile(FONT_PATH):
    try:
        pdfmetrics.registerFont(TTFont("DejaVuSans", FONT_PATH))
        FONT_NAME = "DejaVuSans"
    except Exception:
        FONT_NAME = "Helvetica"
else:
    FONT_NAME = "Helvetica"

@st.cache_data
def load_logo_bytes():
    try:
        with open("logo.png", "rb") as f:
            return f.read()
    except FileNotFoundError:
        return None

# -------------------------
# YardÄ±mcÄ± Fonksiyonlar
# -------------------------
def normalize_pay_token(token: str) -> str | None:
    if not isinstance(token, str): return None
    t = unicodedata.normalize("NFKC", token).strip().lower().replace(" ", "")
    if t in ("Ã¼a", "ua"): return "ÃœA"
    if t in ("Ã¼g", "ug"): return "ÃœG"
    return None

def sanitize_filename(s: str) -> str:
    s = re.sub(r'[^\w\s-]', '', s, flags=re.UNICODE).strip()
    return re.sub(r'\s+', '_', s)[:60] or "etiket"

def get_pagesize(name="A4"):
    if name == "100x100": return (100*mm, 100*mm)
    if name == "A4": return A4
    return (148*mm, 210*mm)

def open_print_window_with_html(html: str):
    components.html(html, height=0, scrolling=False)

# --- PDF ve HTML Ã‡izim FonksiyonlarÄ± ---
# (Draw, build_single_label_pdf, build_bulk_pdf, make_print_html, make_bulk_print_html)
# Bu kÄ±sÄ±mlar Ã¶nceki kod ile aynÄ± kalabilir; burada kÄ±saltÄ±yoruz ama entegre olacak

# ------------------------------------------------
# UI (ArayÃ¼z)
# ------------------------------------------------
st.title("ğŸ“¦ Kargo Etiket OluÅŸturucu")

# -------------------------
# GÃ¶nderici SeÃ§imi ve Manuel DÃ¼zenleme
# -------------------------
with st.expander("ğŸ”§ GÃ¶nderici Bilgileri", expanded=True):
    st.subheader("GÃ¶nderici SeÃ§iniz")
    col1, col2 = st.columns(2)
    if 'gonderici' not in st.session_state:
        st.session_state['gonderici'] = SENDER_BLOCK_DEFAULT

    with col1:
        if st.button("Ä°stanbul Showroom"):
            st.session_state['gonderici'] = ISTANBUL_INFO
    with col2:
        if st.button("Ankara Showroom"):
            st.session_state['gonderici'] = ANKARA_INFO

    # Manuel deÄŸiÅŸiklik alanÄ±
    manuel_gonderici = st.text_area(
        "GÃ¶nderici bilgisini manuel deÄŸiÅŸtirmek istersen buraya yaz:",
        value=st.session_state['gonderici'],
        height=140
    )

# -------------------------
# Excel Verisi AlanÄ±
# -------------------------
with st.sidebar:
    st.subheader("Excel Verisi")
    st.info("Excel'de satÄ±rÄ±n tamamÄ±nÄ± seÃ§ip (Ã¶rn: satÄ±r numarasÄ±na tÄ±klayarak) kopyalayÄ±n ve buraya yapÄ±ÅŸtÄ±rÄ±n.")
    raw_input_data = st.text_area("YapÄ±ÅŸtÄ±rÄ±lacak Alan:", height=350, key="raw_data_input")

# -------------------------
# TasarÄ±m AyarlarÄ±
# -------------------------
with st.expander("ğŸ”§ TasarÄ±m AyarlarÄ±", expanded=True):
    col1, col2 = st.columns(2)
    with col1:
        page_size_name = st.selectbox("Etiket Boyutu", ["A4", "A5", "100x100"], index=0)
    with col2:
        badge_scale = st.slider("Ãœcret Rozeti Boyutu", 1.0, 2.0, 1.7, 0.1)

sender_block = manuel_gonderici  # Son seÃ§ilen veya manuel gÃ¶nderici

# -------------------------
# Veri Okuma ve Ä°ÅŸleme
# -------------------------
rows = []
error_lines = 0
if raw_input_data:
    try:
        df = pd.read_csv(io.StringIO(raw_input_data), sep='\t', header=None, engine='python', on_bad_lines='skip')
        df.dropna(how='all', inplace=True)
        for index, row in df.iterrows():
            if len(row) < MIN_COLUMN_COUNT:
                error_lines += 1
                continue
            name_cell = str(row[COL_NAME]) if pd.notna(row[COL_NAME]) else ""
            if name_cell.strip():
                rows.append({
                    "name": name_cell.strip(),
                    "address": str(row[COL_ADDRESS]) if pd.notna(row[COL_ADDRESS]) else "",
                    "phone": str(row[COL_PHONE]) if pd.notna(row[COL_PHONE]) else "",
                    "parsed_pay": normalize_pay_token(str(row[COL_PAYMENT]) if pd.notna(row[COL_PAYMENT]) else ""),
                })
            else:
                error_lines += 1
    except Exception as e:
        st.error(f"Veri iÅŸlenirken bir hata oluÅŸtu: {e}")
        st.warning("LÃ¼tfen veriyi Excel'den tÃ¼m satÄ±rÄ± seÃ§erek kopyaladÄ±ÄŸÄ±nÄ±zdan emin olun.")

# -------------------------
# SonuÃ§larÄ±n GÃ¶sterilmesi ve PDF/HTML Ä°ÅŸlemleri
# -------------------------
# (Bu kÄ±sÄ±m Ã¶nceki kod ile aynÄ±, rows Ã¼zerinden dÃ¶ngÃ¼ ile tekil ve toplu PDF oluÅŸturma, download ve print butonlarÄ±)
